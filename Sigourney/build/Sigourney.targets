<!--
Copyright (c) 2020 Theodore Tsirpanis

This software is released under the MIT License.
https://opensource.org/licenses/MIT
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
  TreatAsLocalProperty="_SigourneyEnable">
  <Import Project="$(MSBuildThisFileDirectory)Sigourney.PublishMode.Targets" />
  <PropertyGroup>
    <IntermediateDirectory>$(ProjectDir)$(IntermediateOutputPath)</IntermediateDirectory>
    <_SigourneyEnable Condition="$(SigourneyEnable) == false OR $(DesigntimeBuild) == true">false</_SigourneyEnable>
    <CleanDependsOn>$(CleanDependsOn);SigourneyCleanSentinels</CleanDependsOn>
  </PropertyGroup>

  <UsingTask Condition="$(_SigourneyEnable) != false" TaskName="GetNextSentinel" AssemblyFile="$(SigourneyAssembly)" />
  <Import
    Condition="$(_SigourneyEnable) != false AND '$(SigourneyRegisteredTargetFiles)' != ''"
    Project="$(SigourneyRegisteredTargetFiles)" />

  <Target Name="SigourneyLoadConfiguration">
    <ItemGroup>
      <SigourneyConfiguration Include="Sigourney default configuration">
        <SignAssembly>$(SignAssembly)</SignAssembly>
        <IntermediateDirectory>$(IntermediateDirectory)</IntermediateDirectory>
        <KeyOriginatorFile>$(KeyOriginatorFile)</KeyOriginatorFile>
        <AssemblyOriginatorKeyFile>$(AssemblyOriginatorKeyFile)</AssemblyOriginatorKeyFile>
        <References>@(ReferencePath)</References>
      </SigourneyConfiguration>
    </ItemGroup>
  </Target>

  <Target
    Name="SigourneyEntryPoint"
    Condition="$(_SigourneyEnable) != false AND '$(SigourneyRegisteredTargets)' != ''"
    AfterTargets="AfterCompile"
    DependsOnTargets="SigourneyLoadConfiguration;$(SigourneyRegisteredTargets)">
  </Target>

  <Target Name="SigourneyCleanSentinels">
    <ItemGroup>
      <_SigourneyAllSentinels Include="$(IntermediateDirectory)ProcessedBySigourney.*" />
    </ItemGroup>
    <Delete Files="@(_SigourneyAllSentinels)" />
  </Target>
</Project>
